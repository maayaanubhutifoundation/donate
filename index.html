<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Donate to Maaya Anubhuti Foundation</title>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://challenges.cloudflare.com/turnstile/v0/api.js" async defer></script>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <style>
    body { background-color:#7846e4; padding:40px 10px; }
    .container { max-width:720px; margin:auto; background:#fff; padding:30px; border-radius:10px; box-shadow:0 0 12px rgba(0,0,0,0.1); }
    h1 { color:#e68a00; text-align:center; margin-bottom:5px; }
    .lead { font-size:1rem; color:#444; text-align:center; margin-bottom:25px; }
    .form-control { width:100%; }
    .mobile-wrapper { position:relative; }
    .mobile-wrapper input { padding-left:50px; }
    .mobile-wrapper::before {
      content:"+91"; position:absolute; left:12px; top:50%; transform:translateY(-50%);
      font-weight:bold; color:#555;
    }
    .btn-primary { background-color:#ff9900; border:none; }
    .btn-primary:hover { background-color:#e68a00; }
    #authConfirmed { display:none; margin-top:20px; padding:12px; background:#e8f8ec; border-left:5px solid green; color:#155724; font-weight:bold; }
    #donationOptions { display:none; margin-top:20px; }
    #otpSection { margin-bottom:15px; background:#eef5ff; padding:15px; border-radius:8px; }

    /* Consent checkboxes */
    .form-check-input { border:2px solid #007bff !important; box-shadow:none !important; }
    .form-check-input:checked { background-color:#007bff !important; border-color:#007bff !important; }
    .form-check-label { color:#004085 !important; font-weight:500; }

    /* Inputs */
    .form-control, .form-select {
      border:2px solid #7846e4 !important;
      border-radius:12px !important;
      box-shadow: inset 0 0 0 2px rgba(120,70,228,.08);
    }
    .form-control:focus, .form-select:focus {
      border-color:#5129d6 !important;
      box-shadow: 0 0 0 4px rgba(120,70,228,.20), inset 0 0 0 2px rgba(120,70,228,.08);
      outline:none;
    }

    /* Section wrapper */
    .field-section {
      border:3px solid #7846e4;
      border-radius:14px;
      padding:16px;
      margin-bottom:16px;
      background:#fff;
      box-shadow: 0 8px 20px rgba(17,24,39,.06);
    }

    /* 80G fields hidden until Yes */
    #undertakingWrap, #panWrap, #addrWrap { display:none; }
  </style>
</head>
<body>
  <div class="container">
    <!-- Logo -->
    <div style="text-align: right; margin-bottom: -30px;">
      <img src="https://assets.zyrosite.com/cdn-cgi/image/format=auto,w=375,h=429,fit=crop/A0xj3j1bO7C10DBz/logo_maf-Awv9zveMloUr16Ba.jpeg" alt="MAF Logo" style="height: 60px; border-radius: 5px;">
    </div>

    <h1>Support Maaya Anubhuti Foundation üíõ</h1>
    <p class="lead">Your generous donation helps us care for the elderly, build a compassionate environment, and train youth to serve with dignity. Join us in bringing hope and care to those who need it most.</p>

    <div style="color:#7846e4; font-size:.9rem; font-weight:500; border-left:4px solid #007bff; padding-left:10px; margin-bottom:12px;">
      <p><strong>‚ÄúYOUR CONTRIBUTIONS ARE ELIGIBLE FOR 50% TAX BENEFIT UNDER SECTION 80G AS MAAYA ANUBHUTI FOUNDATION IS REGISTERED AS NON-PROFIT ORGANIZATION‚Äù</strong>.</p>
      <p><strong>PAN: AATCM5136F | 80G NUMBER: AATCM5136FF20251</strong>.</p>
    </div>

    <!-- Quotes -->
    <div class="mt-3" style="font-size: 0.9rem; color: #333;">
      <p><strong>‚ÄúIt's not how much we give but how much love we put into giving.‚Äù</strong> ‚Äì Mother Teresa</p>
      <p><strong>‚ÄúThe best way to find yourself is to lose yourself in the service of others.‚Äù</strong> ‚Äì Mahatma Gandhi</p>
      <p><strong>‚ÄúWe make a living by what we get, but we make a life by what we give.‚Äù</strong> ‚Äì Winston Churchill</p>
    </div>

    <form id="donationForm" novalidate>
      <div class="field-section">
        <div class="mb-3">
          <label id="nameLabel" class="form-label">Full Name*</label>
          <input type="text" class="form-control" id="name" required>
        </div>

        <div class="mb-3">
          <label class="form-label">Mobile Number*</label>
          <div class="mobile-wrapper">
            <input type="tel" class="form-control" id="mobile" pattern="[0-9]{10}" required placeholder="xxxxxxxxxx">
          </div>
        </div>

        <div id="otpSection" class="d-none">
          <label for="otp" class="form-label">Enter OTP:</label>
          <input type="text" id="otp" class="form-control mt-1" autofocus />
          <div id="otpFeedback" class="fw-bold mt-2"></div>
        </div>

        <div class="mb-3">
          <label class="form-label">Email (Optional)</label>
          <input type="email" class="form-control" id="email">
        </div>

        <!-- 80G Toggle (Default = No) -->
        <div class="mb-3">
          <label class="form-label d-block mb-1">Require 80G Tax Exemption Certificate?</label>
          <div class="form-check form-check-inline">
            <input class="form-check-input" type="radio" name="need80g" id="need80gYes" value="yes">
            <label class="form-check-label" for="need80gYes">Yes</label>
          </div>
          <div class="form-check form-check-inline">
            <input class="form-check-input" type="radio" name="need80g" id="need80gNo" value="no" checked>
            <label class="form-check-label" for="need80gNo">No</label>
          </div>
        </div>

        <!-- 80G Undertaking + Conditional fields -->
        <div class="mb-3" id="undertakingWrap">
          <div class="form-check">
            <input class="form-check-input" type="checkbox" id="undertaking80g">
            <label class="form-check-label" for="undertaking80g">
              <strong>I confirm my PAN and address are correct and consent to verification for 80G reporting (Form 10BD/10BE).</strong>
            </label>
          </div>
        </div>

        <div class="mb-3" id="panWrap">
          <label class="form-label" for="pan">PAN*</label>
          <input type="text" class="form-control" id="pan"
                 style="text-transform:uppercase;"
                 maxlength="10"
                 pattern="^[A-Z]{5}[0-9]{4}[A-Z]$"
                 autocomplete="off"
                 inputmode="latin"
                 title="Format: 5 letters + 4 digits + 1 letter (e.g., ABCDE1234F)">
          <div class="form-text" id="panHint"></div>
        </div>

        <div class="mb-3" id="addrWrap">
          <label class="form-label" for="address">Address*</label>
          <input type="text" class="form-control" id="address">
        </div>

        <div class="mb-0">
          <label class="form-label">Message (Optional)</label>
          <textarea class="form-control" id="message" rows="2"></textarea>
        </div>
      </div>

      <div style="color:#7846e4; font-size:.9rem; font-weight:500; border-left:4px solid #007bff; padding-left:10px; margin-bottom:12px;">
        You are requested to authenticate your mobile number by pressing the <strong>Submit</strong> button before the QR code, UPI ID, and Bank details become visible to you for donation.
      </div>

      <div class="form-check mb-2">
        <input class="form-check-input" type="checkbox" id="declaration" required>
        <label class="form-check-label" for="declaration">
          I hereby declare I am an Indian citizen
          <span id="more" style="display: none;"> donating my own funds. I consent to contact via WhatsApp/email/SMS for donation updates, receipts.</span>
          <button type="button" id="readToggle" class="btn btn-link p-0" style="font-size: 13px;" onclick="toggleReadMore()">Read More</button>
        </label>
      </div>

      <div class="form-check mb-2">
        <input class="form-check-input" type="checkbox" id="anonymous">
        <label class="form-check-label" for="anonymous"> I opt to remain anonymous and not have my name published on the website.</label>
      </div>
      <div class="form-check mb-3">
        <input class="form-check-input" type="checkbox" id="receipt">
        <label class="form-check-label" for="receipt">I would like to receive the receipt via WhatsApp/email.</label>
      </div>

      <div class="cf-turnstile" data-sitekey="0x4AAAAAABnuBDDS5ho0ShrZ"></div>
      <button type="button" class="btn btn-primary w-100 mt-3" id="submitBtn">Submit</button>
    </form>

    <div id="authConfirmed">‚úÖ Mobile number authenticated. You may now please proceed with your donation.</div>

    <div id="donationOptions">
      <h5 class="mt-3">Donation Options</h5>
      <div class="row text-center">
        <div class="col-md-4 mb-3">
          <div class="card h-100">
            <div class="card-body">
              <div style="font-size: 30px;">üí≥</div>
              <h6 class="card-title mt-2">Scan & Pay</h6>
              <img id="qrCodeImage" src="https://assets.zyrosite.com/cdn-cgi/image/format=auto,w=384,h=448,fit=crop/A0xj3j1bO7C10DBz/qr_code-m6Lb0BlRRqs7MEGd.png" alt="QR" class="img-fluid" style="max-width: 120px;">
              <br>
              <button onclick="downloadQR()" class="btn btn-sm btn-outline-primary mt-2">Download QR Code</button>
              <small class="d-block mt-1 text-muted" style="font-size: 0.8rem;">
                To use this QR on the same phone, download it and then upload it from your gallery in PayTM or UPI app.
              </small>
            </div>
          </div>
        </div>
        <div class="col-md-4 mb-3">
          <div class="card h-100">
            <div class="card-body">
              <div style="font-size: 30px;">üî¢</div>
              <h6 class="card-title mt-2">UPI ID</h6>
              <p id="upiText">9599914274@idbi</p>
              <button onclick="copyText('upiText')" class="btn btn-sm btn-outline-primary">Copy UPI ID</button>
            </div>
          </div>
        </div>
        <div class="col-md-4 mb-3">
          <div class="card h-100">
            <div class="card-body">
              <div style="font-size: 30px;">üè¶</div>
              <h6 class="card-title mt-2">Bank Transfer</h6>
              <small>
                A/C No: <span id="accNo">0873102000012698</span><br>
                IFSC: IBKL0000873<br>
                Bank: IDBI Bank<br>
                Branch: Indirapuram, Ghaziabad
              </small><br>
              <button onclick="copyText('accNo')" class="btn btn-sm btn-outline-primary mt-2">Copy Account No</button>
            </div>
          </div>
        </div>

        <div class="col-md-6 offset-md-3 mb-3">
          <div class="card h-100">
            <div class="card-body">
              <div style="font-size: 30px;">üìÆ</div>
              <h6 class="card-title mt-2">Offline (Cheque/DD)</h6>
              <small>
                Please send your Cheque/DD in favor of:<br>
                <strong>Maaya Anubhuti Foundation</strong><br>
                Address: 3A-232, Rachna, Vaishali, Ghaziabad, UP ‚Äì 201010
              </small>
            </div>
          </div>
        </div>
      </div>

      <p class="text-muted small mt-3">
        Maaya Anubhuti Foundation, a registered Section 8 Non-profit organisation (License No. 169918, CIN: U86900UP2025NPL226294, PAN: AATCM5136F), operates with a commitment to transparency and integrity. None of the members of our NGO receive salaries or any monetary benefits from the organization's funds.
      </p>
    </div>
  </div>

  <div id="recaptcha-container" style="display: none;"></div>

  <script>
    function toggleReadMore() {
      const moreText = document.getElementById("more");
      const btn = document.getElementById("readToggle");
      if (moreText.style.display === "none") {
        moreText.style.display = "inline";
        btn.textContent = "Read Less";
      } else {
        moreText.style.display = "none";
        btn.textContent = "Read More";
      }
    }
    function copyText(id) {
      const text = document.getElementById(id).innerText;
      navigator.clipboard.writeText(text).then(() => alert("Copied: " + text));
    }
    function downloadQR() {
      const link = document.createElement('a');
      link.href = document.getElementById('qrCodeImage').src;
      link.download = 'MAF_QR_Code.png';
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
    }

    const firebaseConfig = {
      apiKey: "AIzaSyAG6BcfLCiBG4nX2dqa0YDCqtbgiET4qQg",
      authDomain: "maaya-donation-project.firebaseapp.com",
      projectId: "maaya-donation-project",
      storageBucket: "maaya-donation-project.appspot.com",
      messagingSenderId: "893542409484",
      appId: "1:893542409484:web:6ce0ff5bc7e51de69f1529"
    };
    firebase.initializeApp(firebaseConfig);

    let confirmationResult;
    const submitBtn = document.getElementById("submitBtn");
    const otpSection = document.getElementById("otpSection");
    const otpInput = document.getElementById("otp");
    const otpFeedback = document.getElementById("otpFeedback");
    const authConfirmed = document.getElementById("authConfirmed");
    const donationForm = document.getElementById("donationForm");
    const donationOptions = document.getElementById("donationOptions");

    // [80G] toggle logic (Default = No)
    const need80gYes = document.getElementById('need80gYes');
    const need80gNo  = document.getElementById('need80gNo');
    const undertakingWrap = document.getElementById('undertakingWrap');
    const undertaking80g  = document.getElementById('undertaking80g');
    const panWrap    = document.getElementById('panWrap');
    const addrWrap   = document.getElementById('addrWrap');
    const panInput   = document.getElementById('pan');
    const addrInput  = document.getElementById('address');
    const nameInput  = document.getElementById('name');
    const nameLabel  = document.getElementById('nameLabel');
    const panHint    = document.getElementById('panHint');

    function need80gValue(){ const r=document.querySelector('input[name="need80g"]:checked'); return r?r.value:'no'; }

    function toggle80G(){
      const need=(need80gValue()==='yes');
      undertakingWrap.style.display = need ? 'block' : 'none';
      panWrap.style.display = need ? 'block' : 'none';
      addrWrap.style.display = need ? 'block' : 'none';

      undertaking80g.required = need;
      panInput.required = need;
      addrInput.required = need;

      nameLabel.textContent = need ? 'Name as per PAN*' : 'Full Name*';

      if(!need){
        undertaking80g.checked = false;
        panInput.value=''; addrInput.value='';
        panInput.setCustomValidity(''); panHint.textContent='';
      }
    }
    need80gYes.addEventListener('change',toggle80G);
    need80gNo.addEventListener('change',toggle80G);
    toggle80G(); // init with No

    // PAN validation: format + 5th-letter vs name rule
    const PAN_REGEX = /^[A-Z]{5}[0-9]{4}[A-Z]$/;

    function getPanTypeChar(pan){ return pan?.toUpperCase().charAt(3) || ''; } // 4th char
    function getFifthChar(pan){ return pan?.toUpperCase().charAt(4) || ''; }    // 5th char
    function getSurnameInitial(name){
      const parts = (name||'').trim().split(/\s+/);
      const last = parts[parts.length-1] || '';
      const letter = (last.match(/[A-Za-z]/)?.[0]||'').toUpperCase();
      return letter;
    }
    function getEntityInitial(name){
      const letter = ((name||'').trim().match(/[A-Za-z]/)||[''])[0].toUpperCase();
      return letter;
    }

    function explainType(t){
      switch(t){
        case 'P': return 'Individual';
        case 'C': return 'Company';
        case 'H': return 'HUF';
        case 'F': return 'Firm/LLP';
        case 'A': return 'AOP';
        case 'B': return 'BOI';
        case 'T': return 'Trust';
        case 'L': return 'Local Authority';
        case 'J': return 'Artificial Juridical Person';
        case 'G': return 'Government';
        default: return '';
      }
    }

    function validatePAN(){
      if(need80gValue()!=='yes'){ panInput.setCustomValidity(''); panHint.textContent=''; return; }

      const pan = panInput.value.toUpperCase();
      const name = nameInput.value;

      if(!PAN_REGEX.test(pan)){
        panInput.setCustomValidity('Invalid PAN format. Example: ABCDE1234F');
        panHint.textContent = 'Format must be 5 letters + 4 digits + 1 letter (e.g., ABCDE1234F).';
        return;
      }

      const typeChar  = getPanTypeChar(pan); // 4th
      const fifthChar = getFifthChar(pan);

      // Compute expected initial from name based on type
      let expectedInitial = '';
      if(typeChar === 'P'){ // Individual
        expectedInitial = getSurnameInitial(name);
      }else{ // Non-individual
        expectedInitial = getEntityInitial(name);
      }

      if(!expectedInitial){
        panInput.setCustomValidity('Enter the '+(typeChar==='P'?'surname (last word)':'entity name')+' so its initial matches PAN 5th letter.');
        panHint.textContent = 'PAN Type: '+typeChar+' ('+explainType(typeChar)+'). The 5th PAN letter "'+fifthChar+'" must match '+(typeChar==='P'?'Surname initial':'Entity initial')+'.';
        return;
      }

      if(fifthChar !== expectedInitial){
        panInput.setCustomValidity('Name mismatch: PAN 5th letter "'+fifthChar+'" should match '+(typeChar==='P'?'Surname':'Entity')+' initial "'+expectedInitial+'".');
        panHint.textContent = 'PAN Type: '+typeChar+' ('+explainType(typeChar)+'). Expected initial "'+expectedInitial+'", got "'+fifthChar+'".';
        return;
      }

      // All good
      panInput.setCustomValidity('');
      panHint.textContent = 'PAN Type: '+typeChar+' ('+explainType(typeChar)+'). Name initial matches.';
    }

    panInput.addEventListener('input', ()=>{ panInput.value = panInput.value.toUpperCase(); validatePAN(); });
    nameInput.addEventListener('input', validatePAN);

    // OTP auto-submit
    const otpInput = document.getElementById("otp");
    otpInput.addEventListener("input", () => {
      if (otpInput.value.length === 6 && confirmationResult) submitBtn.click();
    });

    // Submit/OTP flow (unchanged except we require undertaking when 80G=Yes and send panType)
    const otpFeedback = document.getElementById("otpFeedback");
    const submitBtn = document.getElementById("submitBtn");
    const authConfirmed = document.getElementById("authConfirmed");
    const donationForm = document.getElementById("donationForm");
    const donationOptions = document.getElementById("donationOptions");

    submitBtn.addEventListener("click", () => {
      const mobileValue = document.getElementById("mobile").value;
      if (!/^([6-9])\d{9}$/.test(mobileValue)) return alert("Please enter a valid 10-digit mobile number starting with 6‚Äì9.");
      if (!document.getElementById("declaration").checked) return alert("Please accept the declaration.");

      // 80G conditional validation
      if(need80gValue()==='yes'){
        if(!undertaking80g.checked) return alert("Please confirm the 80G undertaking.");
        validatePAN();
        if(panInput.validationMessage){
          alert(panInput.validationMessage);
          return;
        }
        if(!addrInput.value.trim()) return alert("Address is required for 80G receipt.");
      }

      const phone = "+91" + mobileValue;

      if (!confirmationResult) {
        submitBtn.disabled = true;
        submitBtn.textContent = "Sending OTP...";
        try {
          window.recaptchaVerifier = new firebase.auth.RecaptchaVerifier('recaptcha-container', { size: 'invisible' });
          window.recaptchaVerifier.verify().then(() => {
            return firebase.auth().signInWithPhoneNumber(phone, window.recaptchaVerifier);
          }).then(result => {
            confirmationResult = result;
            document.getElementById("otpSection").classList.remove("d-none");
            otpInput.focus();
            submitBtn.disabled = false;
            submitBtn.textContent = "Submit OTP for Donation";
          }).catch(err => {
            alert("Error sending OTP: " + err.message);
            submitBtn.disabled = false;
            submitBtn.textContent = "Submit";
          });
        } catch (e) {
          alert("Unexpected error. Please reload and try again.");
          submitBtn.disabled = false;
          submitBtn.textContent = "Submit";
        }
      } else {
        confirmationResult.confirm(otpInput.value).then(() => {
          authConfirmed.style.display = "block";
          donationForm.style.display = "none";
          donationOptions.style.display = "block";

          const wants80g = (need80gValue()==='yes');
          const panVal   = wants80g ? (panInput.value || "").toUpperCase() : "";
          const panType  = panVal ? getPanTypeChar(panVal) : ""; // one-letter P/C/H/F/A/B/T/L/J/G

          fetch("https://hook.eu2.make.com/lsq9xd18wvu7xqueguw0jx55qry344q4", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              timestamp: new Date().toISOString(),
              name: document.getElementById("name").value,
              phone: document.getElementById("mobile").value,
              email: document.getElementById("email").value,
              pan: panVal,
              panType: panType,                  // optional, for your Sheet
              address: wants80g ? document.getElementById("address").value : "",
              message: document.getElementById("message").value,
              anonymous: document.getElementById("anonymous").checked ? "Yes" : "No",
              receipt: document.getElementById("receipt").checked ? "Yes" : "No",
              status: "Verified",
              verified: "Yes"
            })
          }).then(() => console.log("‚úÖ Sent to Make.com"))
            .catch(err => console.error("‚ùå Make error:", err));

        }).catch(err => {
          otpFeedback.textContent = "Wrong OTP";
          otpFeedback.style.color = "red";
        });
      }
    });
  </script>
</body>
</html>
