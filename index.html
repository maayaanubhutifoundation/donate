<!DOCTYPE html> 
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Donate to Maaya Anubhuti Foundation</title>

  <!-- Firebase (unchanged) -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>

  <!-- Turnstile (unchanged) -->
  <script src="https://challenges.cloudflare.com/turnstile/v0/api.js" async defer></script>

  <!-- Bootstrap -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

  <style>
    :root{ --maf-violet:#7846e4; --maf-accent:#ff9900; }
    html,body{ font-size:18px; }
    body{ background-color: var(--maf-violet); padding:40px 10px; }
    .page-wrap{ max-width: 1140px; margin: 0 auto; }

    /* Header */
    .hero-card{
      background:#fff; border-radius:12px; padding:20px 24px; box-shadow:0 6px 20px rgba(0,0,0,.08);
    }
    .brand-title{ color:#e68a00; margin:0 0 2px; font-weight:700; }

    /* 80G row id (to hide post-auth) */
    #need80gRow .form-check{ margin-right:10px; }

    /* Unified two-column card */
    .unified-card{
      background:#fff; border-radius:12px; box-shadow:0 10px 28px rgba(0,0,0,.12);
      padding: 18px; margin-top:14px;
    }
    .divider-lg{ border-left:1px solid #eee; }

    /* Form looks */
    .form-inner{ max-width: 560px; }
    .form-control, .form-select{
      border:2px solid var(--maf-violet) !important;
      border-radius:12px !important;
      box-shadow: inset 0 0 0 2px rgba(120,70,228,.08);
      font-size:1rem;
    }
    .form-control:focus, .form-select:focus{
      border-color:#5129d6 !important;
      box-shadow:0 0 0 4px rgba(120,70,228,.20), inset 0 0 0 2px rgba(120,70,228,.08);
      outline:none;
    }
    .form-floating > label{ padding-left:.9rem; color:#495057; }
    .form-floating .form-control::placeholder{ color:transparent; }

    /* Asterisk for required labels */
    .req::after{ content:" *"; color:#d32f2f; font-weight:700; }

    .input-group-text{ font-weight:700; }

    .btn-primary{ background-color: var(--maf-accent); border:none; }
    .btn-primary:hover{ background-color:#e68a00; }

    /* OTP section */
    #otpSection{ display:none; margin-bottom:12px; background:#eef5ff; padding:12px; border-radius:8px; }
    #otpSentInfo{ font-size:.9rem; }

    .cf-turnstile{ margin-top:8px; }

    #authConfirmed{
      display:none; margin-top:20px; padding:12px;
      background:#e8f8ec; border-left:5px solid green; color:#155724; font-weight:700;
    }
    #donationOptions{ display:none; margin-top:20px; }

    /* Right column */
    .about-title{ color:var(--maf-violet); font-weight:700; }
    .about-box p{ margin-bottom:.7rem; }
    blockquote{ border-left:4px solid #eee; padding-left:.75rem; margin:.5rem 0; font-size:.95rem; color:#7846e4; }

    /* Ribbons */
    .ribbon{ color:var(--maf-violet); font-size:.95rem; font-weight:600; border-left:4px solid #007bff; padding-left:10px; }

    /* Quotes placement: mobile top vs desktop right */
    #topQuotes{ color:#7846e4; font-size:.95rem; }

    /* Countdown badge */
    .clock-badge{
      display:inline-flex; align-items:center; gap:.25rem;
      font-size:.85rem; padding:.125rem .5rem; border-radius:999px; background:#fff; border:1px solid #cbd5e1; color:#334155;
    }

    /* Checkbox highlight (all four checkboxes) */
    .check-hi{
      background:#fff8e1; /* soft yellow */
      border:1px solid #f6d28b;
      border-radius:10px;
      padding:.6rem .75rem;
      margin-bottom:.6rem;
    }
    .check-hi .form-check-input{
      border-color:#c58f00;
      width:1.1rem; height:1.1rem;
    }
    .check-hi .form-check-label{
      font-weight:600;
      color:#5b3a00;
    }

    /* Responsive */
    @media (max-width: 991.98px){
      .divider-lg{ border-left:none; border-top:1px solid #eee; margin-top:14px; padding-top:14px; }
      .form-inner{ max-width:100%; }
    }
  </style>
</head>
<body>

  <div class="page-wrap">

    <!-- Header / Intro -->
    <div class="hero-card">
      <div class="d-flex justify-content-between align-items-start">
        <div>
          <h1 class="h3 brand-title">Support Maaya Anubhuti Foundation üíõ</h1>
          <p class="mb-2" style="color:#555; font-size:.95rem;">
            Your generous donation helps us care for the elderly, build a compassionate environment, and train youth to serve with dignity.
          </p>
        </div>
        <img src="https://assets.zyrosite.com/cdn-cgi/image/format=auto,w=375,h=429,fit=crop/A0xj3j1bO7C10DBz/logo_maf-Awv9zveMloUr16Ba.jpeg"
             alt="MAF Logo" style="height:56px; border-radius:6px;">
      </div>

      <!-- TOP QUOTES (mobile only) -->
      <div id="topQuotes" class="mt-2 d-lg-none">
        <div><strong>‚ÄúIt's not how much we give but how much love we put into giving.‚Äù</strong> ‚Äî Mother Teresa</div>
        <div><strong>‚ÄúThe best way to find yourself is to lose yourself in the service of others.‚Äù</strong> ‚Äî Mahatma Gandhi</div>
        <div><strong>‚ÄúNo one has ever become poor by giving.‚Äù</strong> ‚Äì Anne Frank</div>
        <div><strong>‚ÄúWe make a living by what we get, but we make a life by what we give.‚Äù</strong> ‚Äî Winston Churchill</div>
      </div>

      <!-- 80G toggle row -->
      <div class="mt-3" id="need80gRow">
        <label class="form-label fw-semibold me-2">I require 80G Tax Exemption Certificate:</label>
        <div class="form-check form-check-inline">
          <input class="form-check-input" type="radio" name="need80g" id="need80gYes" value="yes" checked>
          <label class="form-check-label" for="need80gYes">Yes</label>
        </div>
        <div class="form-check form-check-inline">
          <input class="form-check-input" type="radio" name="need80g" id="need80gNo" value="no">
          <label class="form-check-label" for="need80gNo">No</label>
        </div>

        <!-- Undertaking directly beneath (shows when Yes) -->
        <div class="mt-2" id="undertakingWrap" style="display:none;">
          <div class="form-check check-hi">
            <input class="form-check-input" type="checkbox" id="undertaking80g">
            <label class="form-check-label req" for="undertaking80g">
              I confirm my PAN and address are correct and consent to verification for 80G reporting.
            </label>
          </div>
        </div>
      </div>
    </div>

    <!-- Unified two-column card -->
    <div class="unified-card">
      <div class="row g-3 align-items-start">
        <!-- LEFT (60%): Form -->
        <div class="col-12 col-lg-7">
          <form id="donationForm" class="form-inner">

            <!-- Name -->
            <div class="form-floating mb-3">
              <input type="text" class="form-control" id="name" placeholder="Name as per PAN"
                     style="text-transform:uppercase;" autocomplete="name" required>
              <label for="name" id="nameLabel" class="req">Name as per PAN</label>
            </div>

            <!-- Mobile -->
            <div class="mb-3">
              <label class="form-label req">Mobile Number</label>
              <div class="input-group">
                <span class="input-group-text">+91</span>
                <input type="tel" class="form-control" id="mobile" pattern="[0-9]{10}" placeholder="10-digit number" required>
              </div>
            </div>

            <!-- OTP (appears after OTP is sent) -->
            <div id="otpSection">
              <label for="otp" class="form-label">Enter OTP</label>
              <input type="text" id="otp" class="form-control mt-1" inputmode="numeric" maxlength="6"/>
              <!-- tiny info line -->
              <div id="otpSentInfo" class="text-muted small mt-1"></div>

              <div class="d-flex align-items-center gap-2 mt-2">
                <button type="button" id="resendOtpBtn" class="btn btn-sm btn-outline-secondary" disabled>
                  Resend OTP
                </button>
                <span id="resendCountdown" class="clock-badge" aria-live="polite" style="display:none;">‚è±Ô∏è 01:00</span>
                <span id="resendHelp" class="text-muted small">You can request a new OTP if SMS is delayed.</span>
              </div>

              <div id="otpFeedback" class="fw-bold mt-2"></div>
            </div>

            <!-- Email -->
            <div class="form-floating mb-3">
              <input type="email" class="form-control" id="email" placeholder="Email (Optional)"
                     autocomplete="email" pattern="^[^@\\s]+@[^@\\s]+\\.[^@\\s]+$">
              <label for="email">Email (Optional)</label>
            </div>

            <!-- PAN -->
            <div class="form-floating mb-2" id="panWrap">
              <input type="text" class="form-control" id="pan" placeholder="ABCDE1234F"
                     style="text-transform:uppercase;" maxlength="10">
              <label for="pan" id="panLabel" class="req">PAN (Required for 80G receipt)</label>
            </div>
            <div class="mb-3" id="panHint" style="font-size:.9rem; color:#555;"></div>

            <!-- Address segmented -->
            <div id="addrBlock">
              <div class="form-floating mb-3">
                <select class="form-select" id="country">
                  <option value="">Select Country</option>
                  <option value="India" selected>India</option>
                </select>
                <label for="country" id="countryLabel" class="req">Country</label>
              </div>

              <div class="form-floating mb-3">
                <select class="form-select" id="state">
                  <option value="">Select State</option>
                  <!-- States & UTs -->
                  <option>Andhra Pradesh</option><option>Arunachal Pradesh</option><option>Assam</option>
                  <option>Bihar</option><option>Chhattisgarh</option><option>Goa</option><option>Gujarat</option>
                  <option>Haryana</option><option>Himachal Pradesh</option><option>Jharkhand</option>
                  <option>Karnataka</option><option>Kerala</option><option>Madhya Pradesh</option>
                  <option>Maharashtra</option><option>Manipur</option><option>Meghalaya</option>
                  <option>Mizoram</option><option>Nagaland</option><option>Odisha</option>
                  <option>Punjab</option><option>Rajasthan</option><option>Sikkim</option>
                  <option>Tamil Nadu</option><option>Telangana</option><option>Tripura</option>
                  <option>Uttar Pradesh</option><option>Uttarakhand</option><option>West Bengal</option>
                  <option>Andaman and Nicobar Islands</option><option>Chandigarh</option>
                  <option>Dadra and Nagar Haveli and Daman and Diu</option><option>Delhi</option>
                  <option>Jammu and Kashmir</option><option>Ladakh</option><option>Lakshadweep</option>
                  <option>Puducherry</option>
                </select>
                <label for="state" id="stateLabel" class="req">State</label>
              </div>

              <div class="form-floating mb-3">
                <input type="text" class="form-control" id="city" placeholder="City"
                       style="text-transform:uppercase;" autocomplete="address-level2">
                <label for="city" id="cityLabel" class="req">City</label>
              </div>

              <div class="form-floating mb-3">
                <input type="text" class="form-control" id="address" placeholder="House/Colony/Street"
                       style="text-transform:uppercase;" autocomplete="street-address">
                <label for="address" id="addressLabel" class="req">Address (HN/Colony/Street)</label>
              </div>

              <div class="form-floating mb-3">
                <input type="text" class="form-control" id="pin" placeholder="PIN" inputmode="numeric" maxlength="6">
                <label for="pin" id="pinLabel" class="req">PIN</label>
              </div>
            </div>

            <!-- Message -->
            <div class="form-floating mb-3">
              <textarea class="form-control" id="message" placeholder="Message (Optional)" style="height: 80px"></textarea>
              <label for="message">Message (Optional)</label>
            </div>

            <!-- Instruction -->
            <div class="mb-2 ribbon" style="border-left-color:#007bff;">
              Authenticate your mobile number by pressing <strong>Submit</strong> to reveal QR, UPI and bank details.
            </div>

            <!-- Consents (all highlighted) -->
            <div class="form-check check-hi">
              <input class="form-check-input" type="checkbox" id="declaration" required>
              <label class="form-check-label req" for="declaration">
                I hereby declare I am an Indian citizen
                <span id="more" style="display:none;"> donating my own funds. I consent to contact via WhatsApp/email/SMS for donation updates and receipts.</span>
                <button type="button" id="readToggle" class="btn btn-link p-0" style="font-size:.85rem;">Read More</button>
              </label>
            </div>

            <div class="form-check check-hi">
              <input class="form-check-input" type="checkbox" id="anonymous">
              <label class="form-check-label" for="anonymous" id="anonymousLabel">
                I opt to remain anonymous and
                <button type="button" id="anonReadToggle" class="btn btn-link p-0" style="font-size:.85rem;">Read More</button>
                <span id="anonMore" style="display:none;">
                  not have my name published on the website, but I am aware that if I opt for 80G, my details will be reported
                  to the Income Tax Department (Form 10BD/10BE).
                </span>
              </label>
            </div>

            <div class="form-check check-hi">
              <input class="form-check-input" type="checkbox" id="receipt">
              <label class="form-check-label" for="receipt">I would like to receive the receipt via WhatsApp/email.</label>
            </div>

            <div class="cf-turnstile" data-sitekey="0x4AAAAAABnuBDDS5ho0ShrZ"></div>
            <button type="button" class="btn btn-primary w-100 mt-2" id="submitBtn">Submit</button>
          </form>
        </div>

        <!-- RIGHT (40%): Text / Tax note / Quotes / FAQ -->
        <div class="col-12 col-lg-5 about-box divider-lg">
          <h2 class="h5 about-title">About your contribution</h2>
          <p>Your support nourishes underprivileged elders with meals and clothing today, and builds the foundation for our eco-friendly senior living centre tomorrow.</p>

          <div class="mt-3">
            <div class="ribbon" style="border-left-color:#ddd; color:#222;">
              <div><strong>YOUR CONTRIBUTIONS ARE ELIGIBLE FOR 50% TAX BENEFIT UNDER SECTION 80G.</strong></div>
              <div>PAN: <strong>AATCM5136F</strong> &nbsp; | &nbsp; 80G URN: <strong>AATCM5136FF20251</strong></div>
            </div>

            <!-- Right-column quotes (desktop only) -->
            <div class="d-none d-lg-block">
              <blockquote>‚ÄúIt's not how much we give but how much love we put into giving.‚Äù ‚Äî Mother Teresa</blockquote>
              <blockquote>‚ÄúThe best way to find yourself is to lose yourself in the service of others.‚Äù ‚Äî Mahatma Gandhi</blockquote>
              <blockquote>‚ÄúNo one has ever become poor by giving.‚Äù ‚Äì Anne Frank</blockquote>
              <blockquote>‚ÄúWe make a living by what we get, but we make a life by what we give.‚Äù ‚Äî Winston Churchill</blockquote>
            </div>

            <p class="mt-3 mb-0">
              üëâ For tax-benefit details, see our <a href="https://www.maayaanubhuti.org/support" target="_blank">Donation FAQ</a>.
            </p>
          </div>
        </div>
      </div>
    </div>

    <!-- Success + options -->
    <div id="authConfirmed">‚úÖ Mobile number authenticated. You may now proceed with your donation.</div>

    <div id="donationOptions">
      <h5 class="mt-3 text-white">Donation Options</h5>
      <div class="row text-center">
        <div class="col-md-4 mb-3">
          <div class="card h-100">
            <div class="card-body">
              <div style="font-size:30px;">üí≥</div>
              <h6 class="card-title mt-2">Scan & Pay</h6>
              <img id="qrCodeImage" src="https://assets.zyrosite.com/cdn-cgi/image/format=auto,w=384,h=448,fit=crop/A0xj3j1bO7C10DBz/qr_code-m6Lb0BlRRqs7MEGd.png" alt="QR" class="img-fluid" style="max-width:120px;">
              <br>
              <button onclick="downloadQR()" class="btn btn-sm btn-outline-primary mt-2">Download QR Code</button>
              <small class="d-block mt-1 text-muted" style="font-size:.85rem;">To use this QR on the same phone, download it and then upload it from your UPI app.</small>
            </div>
          </div>
        </div>

        <div class="col-md-4 mb-3">
          <div class="card h-100">
            <div class="card-body">
              <div style="font-size:30px;">üî¢</div>
              <h6 class="card-title mt-2">UPI ID</h6>
              <p id="upiText">9599914274@idbi</p>
              <button onclick="copyText('upiText')" class="btn btn-sm btn-outline-primary">Copy UPI ID</button>
            </div>
          </div>
        </div>

        <div class="col-md-4 mb-3">
          <div class="card h-100">
            <div class="card-body">
              <div style="font-size:30px;">üè¶</div>
              <h6 class="card-title mt-2">Bank Transfer</h6>
              <small>
                A/C No: <span id="accNo">0873102000012698</span><br>
                IFSC: IBKL0000873<br>
                Bank: IDBI Bank<br>
                Branch: Indirapuram, Ghaziabad
              </small><br>
              <button onclick="copyText('accNo')" class="btn btn-sm btn-outline-primary mt-2">Copy Account No</button>
            </div>
          </div>
        </div>

        <div class="col-md-6 offset-md-3 mb-3">
          <div class="card h-100">
            <div class="card-body">
              <div style="font-size:30px;">üìÆ</div>
              <h6 class="card-title mt-2">Offline (Cheque/DD)</h6>
              <small>
                Please send your Cheque/DD in favor of:<br>
                <strong>Maaya Anubhuti Foundation</strong><br>
                Address: 3A-232, Rachna, Vaishali, Ghaziabad, UP ‚Äì 201010
              </small>
            </div>
          </div>
        </div>
      </div>

      <p class="text-white-50 small mt-2">
        Maaya Anubhuti Foundation (Section 8, Licence #169918, CIN U86900UP2025NPL226294, PAN AATCM5136F) operates with transparency and integrity.
      </p>
    </div>

  </div><!-- /page-wrap -->

  <!-- reCAPTCHA host (single!) -->
  <div id="recaptcha-container" style="display:none;"></div>

  <script>
    // Read more toggle for general declaration
    document.getElementById("readToggle").addEventListener("click", () => {
      const more = document.getElementById("more");
      const btn  = document.getElementById("readToggle");
      const show = more.style.display === "none";
      more.style.display = show ? "inline" : "none";
      btn.textContent = show ? "Read Less" : "Read More";
    });

    // Anonymous Read More/Less
    document.getElementById("anonReadToggle").addEventListener("click", () => {
      const more = document.getElementById("anonMore");
      const btn  = document.getElementById("anonReadToggle");
      const show = more.style.display === "none";
      more.style.display = show ? "inline" : "none";
      btn.textContent = show ? "Read Less" : "Read More";
    });

    function copyText(id){
      const text=document.getElementById(id).innerText;
      navigator.clipboard.writeText(text).then(()=>alert("Copied: "+text));
    }

    // Safe, no-navigation QR download (Blob)
    async function downloadQR(){
      try{
        const img = document.getElementById('qrCodeImage');
        const resp = await fetch(img.src, {mode:'cors'});
        const blob = await resp.blob();
        const url = URL.createObjectURL(blob);
        const link=document.createElement('a');
        link.href=url; link.download='MAF_QR_Code.png';
        document.body.appendChild(link); link.click(); document.body.removeChild(link);
        URL.revokeObjectURL(url);
      }catch(e){
        alert("Unable to download QR. Please long-press and save the image.");
      }
    }

    // Firebase (unchanged)
    const firebaseConfig = {
      apiKey: "AIzaSyAG6BcfLCiBG4nX2dqa0YDCqtbgiET4qQg",
      authDomain: "maaya-donation-project.firebaseapp.com",
      projectId: "maaya-donation-project",
      storageBucket: "maaya-donation-project.appspot.com",
      messagingSenderId: "893542409484",
      appId: "1:893542409484:web:6ce0ff5bc7e51de69f1529"
    };
    firebase.initializeApp(firebaseConfig);

    let confirmationResult;
    const submitBtn = document.getElementById("submitBtn");
    const otpSection = document.getElementById("otpSection");
    const otpInputEl = document.getElementById("otp");
    const otpFeedback = document.getElementById("otpFeedback");
    const authConfirmed = document.getElementById("authConfirmed");
    const donationOptions = document.getElementById("donationOptions");

    // RESEND controls
    const resendBtn = document.getElementById("resendOtpBtn");
    const resendCountdownEl = document.getElementById("resendCountdown");
    const otpSentInfo = document.getElementById("otpSentInfo");
    let resendTimer = null;
    const RESEND_SECONDS = 60; // 60s gap

    // 80G controls
    const need80gYes = document.getElementById('need80gYes');
    const need80gNo  = document.getElementById('need80gNo');
    const nameInput  = document.getElementById('name');
    const nameLabel  = document.getElementById('nameLabel');

    const undertakingWrap = document.getElementById('undertakingWrap');
    const undertaking80g  = document.getElementById('undertaking80g');

    const panWrap  = document.getElementById('panWrap');
    const panInput = document.getElementById('pan');
    const panHint  = document.getElementById('panHint');

    const country = document.getElementById('country');
    const state   = document.getElementById('state');
    const city    = document.getElementById('city');
    const address = document.getElementById('address');
    const pin     = document.getElementById('pin');

    // Email -> lowercase
    document.getElementById('email').addEventListener('input', function(){
      this.value = (this.value || '').toLowerCase();
    });

    // Force UPPERCASE also via JS (mobile keyboards)
    ['name','pan','city','address'].forEach(id=>{
      const el = document.getElementById(id);
      if(!el) return;
      el.addEventListener('input', ()=>{ el.value = (el.value||'').toUpperCase(); });
    });

    function need80gValue(){
      const r = document.querySelector('input[name="need80g"]:checked');
      return r ? r.value : 'yes';
    }

    // PAN helpers
    const PAN_REGEX=/^[A-Z]{5}[0-9]{4}[A-Z]$/;
    const getPanTypeChar = p => (p||'').toUpperCase().charAt(3);
    const getFifthChar   = p => (p||'').toUpperCase().charAt(4);
    const surnameInitial = n => ((n||'').trim().split(/\s+/).pop() || '').charAt(0).toUpperCase();
    const entityInitial  = n => (((n||'').trim().match(/[A-Za-z]/) || [''])[0] || '').toUpperCase();
    const typeExplain = t => ({P:'Individual',C:'Company',H:'HUF',F:'Firm/LLP',A:'AOP',B:'BOI',T:'Trust',L:'Local Authority',J:'Artificial Juridical Person',G:'Government'})[t]||'';

    function validatePAN(){
      if(need80gValue()!=='yes'){ panInput.setCustomValidity(''); panHint.textContent=''; return; }
      const pan = (panInput.value||'').toUpperCase(); panInput.value = pan;

      if(!PAN_REGEX.test(pan)){
        panInput.setCustomValidity('Enter a valid PAN (e.g., ABCDE1234F).');
        panHint.textContent='Format: 5 letters + 4 digits + 1 letter.';
        return;
      }
      const t = getPanTypeChar(pan);
      const fifth = getFifthChar(pan);
      const expected = (t==='P') ? surnameInitial(nameInput.value) : entityInitial(nameInput.value);

      if(!expected){
        panInput.setCustomValidity('Please enter your '+(t==='P'?'surname':'name')+' so its initial matches PAN 5th letter.');
        panHint.textContent = 'PAN Type '+t+' ('+typeExplain(t)+'). 5th letter must match your '+(t==='P'?'surname':'name')+' initial.';
        return;
      }
      if(fifth !== expected){
        panInput.setCustomValidity('Name mismatch: expected "'+expected+'", got "'+fifth+'".');
        panHint.textContent = 'Mismatch: expected "'+expected+'", got "'+fifth+'".';
        return;
      }
      panInput.setCustomValidity('');
      panHint.textContent = '‚úî PAN verified ('+typeExplain(t)+').';
    }
    panInput.addEventListener('input', validatePAN);
    nameInput.addEventListener('input', validatePAN);

    function setReq(el, on){ if(!el) return; on ? el.setAttribute('required','required') : el.removeAttribute('required'); }
    function toggleAddrRequired(on){
      setReq(country,on); setReq(state,on); setReq(city,on); setReq(address,on); setReq(pin,on);
      document.getElementById('countryLabel').classList.toggle('req', !!on);
      document.getElementById('stateLabel').classList.toggle('req', !!on);
      document.getElementById('cityLabel').classList.toggle('req', !!on);
      document.getElementById('addressLabel').classList.toggle('req', !!on);
      document.getElementById('pinLabel').classList.toggle('req', !!on);
    }

    // Single reCAPTCHA instance across sends/resends
    let recaptchaVerifier = null;
    let recaptchaWidgetId = null;

    async function ensureRecaptcha() {
      if (!recaptchaVerifier) {
        recaptchaVerifier = new firebase.auth.RecaptchaVerifier('recaptcha-container', { size: 'invisible' });
        recaptchaWidgetId = await recaptchaVerifier.render();
      }
    }

    async function sendOtp(phone){
      await ensureRecaptcha();

      // Reset the widget so a fresh token is generated
      if (window.grecaptcha && recaptchaWidgetId !== null) {
        grecaptcha.reset(recaptchaWidgetId);
      }

      // Verify and send OTP
      await recaptchaVerifier.verify();
      const result = await firebase.auth().signInWithPhoneNumber(phone, recaptchaVerifier);

      // Info line under OTP
      const ten = phone.replace("+91","");
      otpSentInfo.textContent = "OTP sent to +91-XXXXXX" + ten.slice(-4);

      return result;
    }

    // Read More/Less behavior for anonymous label depends on 80G choice
    function setAnonymousTextFor80G(need){
      const anonLabel = document.getElementById("anonymousLabel");
      const anonMore  = document.getElementById("anonMore");
      const anonBtn   = document.getElementById("anonReadToggle");

      if (need) {
        // 80G = Yes -> retain Read More/Less flow
        anonLabel.innerHTML = `
          I opt to remain anonymous and
          <button type="button" id="anonReadToggle" class="btn btn-link p-0" style="font-size:.85rem;">Read More</button>
          <span id="anonMore" style="display:none;">
            not have my name published on the website, but I am aware that if I opt for 80G, my details will be reported
            to the Income Tax Department (Form 10BD/10BE).
          </span>`;
        // re-bind click
        document.getElementById("anonReadToggle").addEventListener("click", () => {
          const more = document.getElementById("anonMore");
          const btn  = document.getElementById("anonReadToggle");
          const show = more.style.display === "none";
          more.style.display = show ? "inline" : "none";
          btn.textContent = show ? "Read Less" : "Read More";
        });
      } else {
        // 80G = No -> short statement only
        anonLabel.innerHTML = "I opt to remain anonymous and not have my name published on the website.";
      }
    }

    function toggle80G(){
      const need = need80gValue()==='yes';

      undertakingWrap.style.display = need ? 'block' : 'none';
      setReq(undertaking80g, need);

      panWrap.style.display = need ? 'block' : 'none';
      setReq(panInput, need);

      document.getElementById('addrBlock').style.display = 'block'; // always visible
      toggleAddrRequired(need);

      const nameLabel = document.getElementById('nameLabel');
      nameLabel.textContent = need ? 'Name as per PAN' : 'Full Name';
      nameLabel.classList.add('req'); // Name always required

      if(!need){
        undertaking80g.checked = false;
        panInput.value=''; panInput.setCustomValidity(''); panHint.textContent='';
      }

      // Adjust anonymous label content for 80G
      setAnonymousTextFor80G(need);
    }
    document.getElementById('need80gYes').addEventListener('change', toggle80G);
    document.getElementById('need80gNo').addEventListener('change', toggle80G);
    toggle80G(); // initialize (default Yes)

    // Validate address when needed
    function validateAddressIfNeeded(){
      const need = need80gValue()==='yes';
      if(!need) return true;
      if(!country.value) { country.focus(); return false; }
      if(!state.value)   { state.focus();   return false; }
      if(!city.value.trim()) { city.focus(); return false; }
      if(!address.value.trim()) { address.focus(); return false; }
      if(!/^\d{6}$/.test(pin.value||'')) { pin.focus(); alert('Please enter a valid 6-digit PIN.'); return false; }
      return true;
    }

    // Auto-submit on full OTP typed (only after OTP exists)
    const otpInputElRef = document.getElementById("otp");
    otpInputElRef && otpInputElRef.addEventListener("input", () => {
      if (otpInputElRef.value.length === 6 && confirmationResult) submitBtn.click();
    });

    // Countdown helpers
    function mmss(n){ const m=String(Math.floor(n/60)).padStart(2,'0'); const s=String(n%60).padStart(2,'0'); return `${m}:${s}`; }
    function startResendCooldown() {
      let remaining = RESEND_SECONDS;
      resendBtn.disabled = true;
      resendCountdownEl.style.display = 'inline-flex';
      resendCountdownEl.textContent = `‚è±Ô∏è ${mmss(remaining)}`;
      if (resendTimer) clearInterval(resendTimer);
      resendTimer = setInterval(() => {
        remaining--;
        resendCountdownEl.textContent = `‚è±Ô∏è ${mmss(remaining)}`;
        if (remaining <= 0) {
          clearInterval(resendTimer);
          resendBtn.disabled = false;
          resendCountdownEl.style.display = 'none';
        }
      }, 1000);
    }

    // >>>>>>>>>> FIX ADDED HERE <<<<<<<<<<
    function validateNameRequired() {
      const nameVal = (nameInput.value || '').trim();
      if (!nameVal) {
        alert("Please enter your name.");
        nameInput.focus();
        return false;
      }
      return true;
    }
    // >>>>>>>> END FIX <<<<<<<<<<

// Submit handler
submitBtn.addEventListener("click", async () => {
  const mobileValue = document.getElementById("mobile").value;

  // block if name empty (applies to both 80G Yes and No)
  if (!validateNameRequired()) return;

  if (!/^([6-9])\d{9}$/.test(mobileValue)) return alert("Please enter a valid 10-digit mobile number starting with 6‚Äì9.");
  if (!document.getElementById("declaration").checked) return alert("Please accept the declaration.");

  if(need80gValue()==='yes'){
    if(!undertaking80g.checked) return alert("Please confirm the 80G undertaking.");
    validatePAN();
    if(panInput.validationMessage){ alert(panInput.validationMessage); return; }
    if(!validateAddressIfNeeded()) return;
  }

  const phone = "+91" + mobileValue;

  // Start OTP if not started
  if (!confirmationResult) {
    submitBtn.disabled = true; submitBtn.textContent = "Sending OTP...";
    try {
      confirmationResult = await sendOtp(phone);

      // Show OTP UI
      document.getElementById('otpSection').style.display = 'block';

      // ‚¨áÔ∏è NEW: bring OTP into view on mobile and focus OTP field
      const otpBox = document.getElementById('otpSection');
      const otpField = document.getElementById('otp');

      // scrollIntoView works well on mobile to jump user to OTP box
      otpBox.scrollIntoView({ behavior: 'smooth', block: 'start' });

      // slight timeout helps on some mobile browsers so the scroll happens before focus triggers keyboard
      setTimeout(() => {
        otpField.focus();
      }, 200);

      startResendCooldown();
      submitBtn.disabled = false; submitBtn.textContent = "Submit OTP for Donation";
    } catch (err) {
      alert("Error sending OTP: " + err.message);
      submitBtn.disabled = false; submitBtn.textContent = "Submit";
    }
    return;
  }

  // Confirm OTP then reveal options + send to Make
  confirmationResult.confirm(document.getElementById('otp').value).then(() => {
    authConfirmed.style.display = "block";

    // Hide 80G row + undertaking post-auth
    document.getElementById('undertakingWrap').style.display = 'none';
    document.getElementById('need80gRow').style.display = 'none';

    // Collapse the two-column card so Donation Options move up
    const uniCard = document.querySelector('.unified-card');
    if (uniCard) uniCard.style.display = 'none';

    donationOptions.style.display = "block";

    const wants80g = (need80gValue()==='yes');
    const panVal = wants80g ? (panInput.value||'').toUpperCase() : '';
    const panType = panVal ? panVal.charAt(3) : '';

    // Prepare payload (keys unchanged)
    const payload = {
      timestamp: new Date().toISOString(),
      name: document.getElementById("name").value,
      phone: document.getElementById("mobile").value,
      email: document.getElementById("email").value || "",
      pan: panVal,
      PAN_Type: panType,
      country: country.value || "",
      state:   state.value   || "",
      city:    city.value    || "",
      address: address.value || "",
      pin:     pin.value     || "",
      message: document.getElementById("message").value || "",
      anonymous: document.getElementById("anonymous").checked ? "Yes" : "No",
      receipt: document.getElementById("receipt").checked ? "Yes" : "No",
      status: "Verified",
      verified: "Yes",
      want_80G: wants80g ? "Yes" : "No"
    };

    // Send to Make (UNCHANGED URL & KEYS)
    fetch("https://hook.eu2.make.com/lsq9xd18wvu7xqueguw0jx55qry344q4", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(payload)
    }).then(() => console.log("‚úÖ Sent to Make.com", payload))
      .catch(err => console.error("‚ùå Make error:", err));

  }).catch(err => {
    otpFeedback.textContent = "Wrong OTP";
    otpFeedback.style.color = "red";
  });
});
  </script>
</body>
</html>
